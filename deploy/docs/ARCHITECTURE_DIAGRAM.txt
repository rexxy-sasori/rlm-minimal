# RLM Secure Architecture with WASM Execution Plane

## High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                     Kubernetes Cluster                          │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              RLM Inference Deployment                    │   │
│  │                                                          │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │              RLM Pod (Replica 1)                │    │   │
│  │  │  ┌─────────────────────────────────────────┐   │    │   │
│  │  │  │         Application Layer                │   │    │   │
│  │  │  │  ┌───────────────────────────────────┐  │   │    │   │
│  │  │  │  │  RLM Logic & Orchestration        │  │   │    │   │
│  │  │  │  │  - Prompt Engineering             │  │   │    │   │
│  │  │  │  │  - Code Generation                │  │   │    │   │
│  │  │  │  │  - Recursion Management           │  │   │    │   │
│  │  │  │  └───────────────────────────────────┘  │   │    │   │
│  │  │  │                                          │   │    │   │
│  │  │  │  ┌───────────────────────────────────┐  │   │    │   │
│  │  │  │  │  Remote REPL Client               │  │   │    │   │
│  │  │  │  │  - HTTP Client to WASM Service    │  │   │    │   │
│  │  │  │  │  - Request/Response Handling      │  │   │    │   │
│  │  │  │  │  - Variable State Management      │  │   │    │   │
│  │  │  │  └───────────────────────────────────┘  │   │    │   │
│  │  │  └─────────────────────────────────────────┘   │    │   │
│  │  │                                                 │    │   │
│  │  │  ┌─────────────────────────────────────────┐   │    │   │
│  │  │  │         LLM Client Layer                │   │    │   │
│  │  │  │  ┌───────────────────────────────────┐  │   │    │   │
│  │  │  │  │  LLM API Client                    │  │   │    │   │
│  │  │  │  │  - OpenAI/Compatible API Calls    │  │   │    │   │
│  │  │  │  │  - Request/Response Processing    │  │   │    │   │
│  │  │  │  └───────────────────────────────────┘  │   │    │   │
│  │  │  └─────────────────────────────────────────┘   │    │   │
│  │  │                                                 │    │   │
│  │  │  ┌─────────────────────────────────────────┐   │    │   │
│  │  │  │         Security Layer                  │   │    │   │
│  │  │  │  ┌───────────────────────────────────┐  │   │    │   │
│  │  │  │  │  Secrets Management                │  │   │    │   │
│  │  │  │  │  - LLM API Key (from k8s Secret)  │  │   │    │   │
│  │  │  │  │  - No Code Execution              │  │   │    │   │
│  │  │  │  └───────────────────────────────────┘  │   │    │   │
│  │  │  └─────────────────────────────────────────┘   │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  │                                                          │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │              RLM Pod (Replica 2)                │    │   │
│  │  │  (Same structure as Replica 1)                  │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  │                                                          │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │              RLM Pod (Replica 3)                │    │   │
│  │  │  (Same structure as Replica 1)                  │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  │                                                          │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │         Service: rlm-inference-service          │    │   │
│  │  │  - Load Balancer                                 │    │   │
│  │  │  - External IP                                   │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              │ HTTP API Calls                   │
│                              │ (POST /execute)                 │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │           WASM Execution Service (Stateless)            │   │
│  │                                                          │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │              WASM Pod (Replica 1)               │    │   │
│  │  │  ┌─────────────────────────────────────────┐   │    │   │
│  │  │  │         HTTP Service Layer                 │   │    │   │
│  │  │  │  ┌───────────────────────────────────┐  │   │    │   │
│  │  │  │  │  HTTP Server (Port 8000)           │  │   │    │   │
│  │  │  │  │  - Request Routing                 │  │   │    │   │
│  │  │  │  │  - JSON Parsing                    │  │   │    │   │
│  │  │  │  │  - Response Formatting             │  │   │    │   │
│  │  │  │  └───────────────────────────────────┘  │   │    │   │
│  │  │  └─────────────────────────────────────────┘   │    │   │
│  │  │                                                 │    │   │
│  │  │  ┌─────────────────────────────────────────┐   │    │   │
│  │  │  │         Execution Layer                 │   │    │   │
│  │  │  │  ┌───────────────────────────────────┐  │   │    │   │
│  │  │  │  │  WASM Executor                     │  │   │    │   │
│  │  │  │  │  - Pyodide Runtime                 │  │   │    │   │
│  │  │  │  │  - Code Execution                  │  │   │    │   │
│  │  │  │  │  - Resource Limiting               │  │   │    │   │
│  │  │  │  │  - Timeout Enforcement             │  │   │    │   │
│  │  │  │  └───────────────────────────────────┘  │   │    │   │
│  │  │  └─────────────────────────────────────────┘   │    │   │
│  │  │                                                 │    │   │
│  │  │  ┌─────────────────────────────────────────┐   │    │   │
│  │  │  │         Security Layer                  │   │    │   │
│  │  │  │  ┌───────────────────────────────────┐  │   │    │   │
│  │  │  │  │  WASM Sandbox                      │  │   │    │   │
│  │  │  │  │  - No LLM API Keys                 │  │   │    │   │
│  │  │  │  │  - Isolated Execution              │  │   │    │   │
│  │  │  │  │  - Resource Quotas                 │  │   │    │   │
│  │  │  │  └───────────────────────────────────┘  │   │    │   │
│  │  │  └─────────────────────────────────────────┘   │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  │                                                          │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │              WASM Pod (Replica 2)               │    │   │
│  │  │  (Same structure as Replica 1)                  │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  │                                                          │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │              WASM Pod (Replica 3)               │    │   │
│  │  │  (Same structure as Replica 1)                  │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  │                                                          │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │         Service: wasm-repl-service             │    │   │
│  │  │  - ClusterIP (Internal only)                   │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              Network Policies                          │   │
│  │  ┌─────────────────────────────────────────────────┐   │   │
│  │  │  RLM → WASM: Allowed                            │   │   │
│  │  │  RLM → LLM API (443): Allowed                   │   │   │
│  │  │  WASM → RLM: Allowed                            │   │   │
│  │  │  Everything Else: Denied                        │   │   │
│  │  └─────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## Data Flow Diagram

```
┌─────────┐
│  User   │
└────┬────┘
     │ 1. Query
     ▼
┌─────────────────────────┐
│  RLM Inference Service  │
│  (Load Balancer)        │
└────────┬────────────────┘
         │ 2. Route to RLM Pod
         ▼
┌─────────────────────────┐
│  RLM Pod (Replica 1)    │
│                         │
│  ┌───────────────────┐  │
│  │  LLM API Client   │  │
│  └────────┬──────────┘  │
│           │ 3. Generate code
│           ▼             │
│  ┌───────────────────┐  │
│  │  RLM Logic        │──┼── 4. Code generated
│  │  (Code Gen)       │  │
│  └────────┬──────────┘  │
│           │             │
│  ┌────────▼──────────┐  │
│  │  Remote REPL      │  │
│  │  Client           │  │
│  └────────┬──────────┘  │
└───────────┼─────────────┘
            │ 5. POST /execute
            ▼
┌─────────────────────────┐
│  WASM Service           │
│  (ClusterIP)            │
└────────┬────────────────┘
         │ 6. Route to WASM Pod
         ▼
┌─────────────────────────┐
│  WASM Pod (Replica 1)   │
│                         │
│  ┌───────────────────┐  │
│  │  HTTP Server      │  │
│  └────────┬──────────┘  │
│           │ 7. Parse request
│           ▼             │
│  ┌───────────────────┐  │
│  │  WASM Executor    │  │
│  │  (Pyodide)        │──┼── 8. Execute in sandbox
│  └────────┬──────────┘  │
│           │             │
│           │ 9. Results  │
│           ▼             │
│  ┌───────────────────┐  │
│  │  Response Builder │  │
│  └────────┬──────────┘  │
└───────────┼─────────────┘
            │ 10. Return results
            ▼
┌─────────────────────────┐
│  RLM Pod (Replica 1)    │
│                         │
│  ┌───────────────────┐  │
│  │  Remote REPL      │  │
│  │  Client           │──┼── 11. Process results
│  └────────┬──────────┘  │
│           │             │
│           ▼             │
│  ┌───────────────────┐  │
│  │  RLM Logic        │──┼── 12. Continue inference
│  │  (Orchestration)  │  │
│  └────────┬──────────┘  │
│           │             │
│           │ 13. Final answer
│           ▼             │
│  ┌───────────────────┐  │
│  │  Response Handler │  │
│  └────────┬──────────┘  │
└───────────┼─────────────┘
            │ 14. Return answer
            ▼
┌─────────────────────────┐
│  RLM Inference Service  │
│  (Load Balancer)        │
└────────┬────────────────┘
         │ 15. Return to user
         ▼
┌─────────┐
│  User   │
└─────────┘
```

## Security Boundaries

```
┌─────────────────────────────────────────────────────────────────┐
│                     Security Boundaries                          │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              Security Boundary #1                        │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │         RLM Inference Plane                     │    │   │
│  │  │  ┌─────────────────────────────────────────┐   │    │   │
│  │  │  │  Trusted Zone                           │   │    │   │
│  │  │  │  - Has LLM API Keys                     │   │    │   │
│  │  │  │  - Generates code (doesn't execute)     │   │    │   │
│  │  │  │  - Network policy: limited egress       │   │    │   │
│  │  │  └─────────────────────────────────────────┘   │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  │                                                          │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │         Network Boundary                       │    │   │
│  │  │  - HTTP API (port 8000)                        │    │   │
│  │  │  - Network policies enforced                   │    │   │
│  │  │  - Only RLM can access WASM service            │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  │                                                          │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │              Security Boundary #2                │    │   │
│  │  │  ┌─────────────────────────────────────────┐   │    │   │
│  │  │  │         WASM Execution Plane             │    │   │
│  │  │  │  ┌─────────────────────────────────────┐ │   │    │   │
│  │  │  │  │  Untrusted Zone                     │ │   │    │   │
│  │  │  │  │  - No LLM API Keys                  │ │   │    │   │
│  │  │  │  │  - Executes generated code          │ │   │    │   │
│  │  │  │  │  - WASM sandbox isolation           │ │   │    │   │
│  │  │  │  │  - Resource quotas per execution    │ │   │    │   │
│  │  │  │  └─────────────────────────────────────┘ │   │    │   │
│  │  │  └─────────────────────────────────────────┘   │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  Defense in Depth:                                              │
│  - Even if Boundary #2 is breached, Boundary #1 remains secure │
│  - LLM API keys never cross into WASM plane                    │
│  - Network policies prevent lateral movement                   │
│  - Resource limits prevent exhaustion attacks                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```
